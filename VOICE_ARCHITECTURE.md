# Voice AI Architecture

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI ADVISORY PAGE (UI)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Message Input Area                               â”‚  â”‚
â”‚  â”‚  [History] [Text Input] [Mic Toggle] [Send Button]      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Voice Mode Indicator (when active)                    â”‚  â”‚
â”‚  â”‚    ğŸ¤ Voice mode: Zephyr [Disable]                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Message List                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ‘¤ User: Your message text                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸŒ± AI: Response text (read aloud if voice on)     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                              â”‚
           â”‚ Text or Voice Mode?          â”‚
           â–¼                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  AIService       â”‚        â”‚ VoiceAIService   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ â€¢ sendMessage()  â”‚        â”‚ â€¢ chatWithVoice()â”‚
    â”‚ â€¢ getHistory()   â”‚        â”‚ â€¢ playAudio()    â”‚
    â”‚ â€¢ sessions()     â”‚        â”‚ â€¢ getVoices()    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                              â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   HTTP Client (http pkg)    â”‚
            â”‚                             â”‚
            â”‚ Authorization + JSON Body   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     Backend Django API               â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  POST /api/voice/chat/               â”‚
        â”‚  POST /api/chat/                     â”‚
        â”‚  GET /api/voice/voices/              â”‚
        â”‚  GET /api/chat/sessions/             â”‚
        â”‚  GET /api/chat/history/{sessionId}/  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚             â”‚             â”‚
            â–¼             â–¼             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  LLM   â”‚   â”‚ TTS    â”‚   â”‚  DB   â”‚
        â”‚Engine  â”‚   â”‚Engine  â”‚   â”‚(msgs) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Audio (MP3)  â”‚
                    â”‚ Base64 Enc   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Network Response                   â”‚
        â”‚                                      â”‚
        â”‚ {                                    â”‚
        â”‚   "response": "text...",             â”‚
        â”‚   "audio_base64": "...encoded...",   â”‚
        â”‚   "session_id": "uuid",              â”‚
        â”‚   "voice_used": "Zephyr"             â”‚
        â”‚ }                                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   VoiceAIService                     â”‚
        â”‚                                      â”‚
        â”‚ 1. Parse response                    â”‚
        â”‚ 2. Decode base64 audio               â”‚
        â”‚ 3. Cache session ID                  â”‚
        â”‚ 4. Play audio                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   AudioPlayer (audioplayers)         â”‚
        â”‚                                      â”‚
        â”‚   â–¶ï¸ Playing... (3.5 sec)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Device Speaker                     â”‚
        â”‚                                      â”‚
        â”‚   ğŸ”Š AI speaks the response          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

### 1. Text Message (Voice Mode OFF)
```
User Input
    â†“
AIAdvisoryPage._sendMessage()
    â†“
AIService.sendMessage(prompt)
    â†“
POST /api/chat/
    â†“
Backend: Process + Generate Response
    â†“
Response: { response: "text", session_id: "uuid" }
    â†“
Display in Chat List
```

### 2. Voice Message (Voice Mode ON)
```
User Input
    â†“
AIAdvisoryPage._sendMessage()
    â†“
VoiceAIService.chatWithVoice(prompt, sessionId, voice)
    â†“
POST /api/voice/chat/
    â†“
Backend: Process + Generate Response + TTS
    â†“
Response: { response: "text", audio_base64: "...", session_id: "uuid" }
    â†“
Split Response & Audio
    â†“
Display Text in Chat List
    â†“
Decode Audio (base64 â†’ bytes)
    â†“
AudioPlayer.play(audio)
    â†“
Speaker Output ğŸ”Š
```

## State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    AIAdvisoryPageState                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  _messages: List<Map>                   â”‚
â”‚    [{text, isUser}, ...]               â”‚
â”‚                                         â”‚
â”‚  _currentSessionId: String?             â”‚
â”‚    â†’ Persisted to SharedPreferences     â”‚
â”‚                                         â”‚
â”‚  _isLoading: bool                       â”‚
â”‚    â†’ Show typing indicator              â”‚
â”‚                                         â”‚
â”‚  _isUsingVoice: bool                    â”‚
â”‚    â†’ Switch between modes               â”‚
â”‚                                         â”‚
â”‚  selectedVoice: String                  â”‚
â”‚    â†’ Current voice: 'Zephyr'            â”‚
â”‚                                         â”‚
â”‚  _isChatHistoryPanelOpen: bool          â”‚
â”‚    â†’ Drawer state                       â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Service Classes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      AIService                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Static Methods:                    â”‚
â”‚  â€¢ setAuthToken()                  â”‚
â”‚  â€¢ sendMessage(text)               â”‚
â”‚  â€¢ getChatHistory(sessionId)       â”‚
â”‚  â€¢ getChatSessions()               â”‚
â”‚  â€¢ startNewSession()               â”‚
â”‚  â€¢ setSessionId(id)                â”‚
â”‚  â€¢ testConnection()                â”‚
â”‚  â€¢ verifyToken()                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–³
         â”‚
    Uses shared:
    â€¢ Token storage
    â€¢ Session management
         â”‚
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    VoiceAIService                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Static Methods:                    â”‚
â”‚  â€¢ initialize(token)               â”‚
â”‚  â€¢ chatWithVoice(msg, voice)       â”‚
â”‚  â€¢ sendVoiceMessage(msg, voice)    â”‚
â”‚  â€¢ playAudio(base64)               â”‚
â”‚  â€¢ stopAudio()                     â”‚
â”‚  â€¢ getAvailableVoices()            â”‚
â”‚  â€¢ getCurrentSessionId()           â”‚
â”‚  â€¢ setSessionId(id)                â”‚
â”‚  â€¢ clearSession()                  â”‚
â”‚  â€¢ dispose()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Backend Integration Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend API (Django + DRF)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  /api/voice/chat/                                  â”‚
â”‚    â”œâ”€ Input: message, session_id, voice, audio    â”‚
â”‚    â””â”€ Output: response, audio_base64, session_id   â”‚
â”‚                                                    â”‚
â”‚  /api/voice/voices/                               â”‚
â”‚    â”œâ”€ Input: (none)                               â”‚
â”‚    â””â”€ Output: voices[]                            â”‚
â”‚                                                    â”‚
â”‚  /api/chat/                                       â”‚
â”‚    â”œâ”€ Input: message                              â”‚
â”‚    â””â”€ Output: response, session_id                â”‚
â”‚                                                    â”‚
â”‚  /api/chat/history/{sessionId}/                   â”‚
â”‚    â”œâ”€ Input: (none)                               â”‚
â”‚    â””â”€ Output: history[]                           â”‚
â”‚                                                    â”‚
â”‚  /api/chat/sessions/                              â”‚
â”‚    â”œâ”€ Input: (none)                               â”‚
â”‚    â””â”€ Output: sessions[]                          â”‚
â”‚                                                    â”‚
â”‚  /api/chat/clear/                                 â”‚
â”‚    â”œâ”€ Input: session_id                           â”‚
â”‚    â””â”€ Output: success                             â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Hierarchy

```
AIAdvisoryPage (StatefulWidget)
    â”‚
    â”œâ”€â”€ Scaffold
    â”‚   â”œâ”€â”€ AppBar (not shown)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ Body: Column
    â”‚   â”‚   â”œâ”€â”€ Error Banner (if error)
    â”‚   â”‚   â”œâ”€â”€ Messages ListView
    â”‚   â”‚   â”‚   â””â”€â”€ EnhancedChatMessageBubble (repeated)
    â”‚   â”‚   â”‚       â”œâ”€â”€ User Message Bubble
    â”‚   â”‚   â”‚       â””â”€â”€ AI Message Bubble
    â”‚   â”‚   â”œâ”€â”€ Typing Indicator (if loading)
    â”‚   â”‚   â””â”€â”€ Message Input Bar
    â”‚   â”‚       â”œâ”€â”€ History Button
    â”‚   â”‚       â”œâ”€â”€ Text Input Field
    â”‚   â”‚       â”œâ”€â”€ Voice Toggle Button âœ¨ NEW
    â”‚   â”‚       â””â”€â”€ Send Button
    â”‚   â”‚
    â”‚   â””â”€â”€ Drawer
    â”‚       â””â”€â”€ ChatHistoryPanel
    â”‚
    â””â”€â”€ Services
        â”œâ”€â”€ AIService (text chat)
        â””â”€â”€ VoiceAIService (voice chat) âœ¨ NEW
            â””â”€â”€ AudioPlayer (plays responses)
```

## Sequence Diagram: Voice Message Flow

```
User          Page            Service         Backend        TTS       Audio
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”œâ”€ Types msg â”€â†’â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”œâ”€ Clicks sendâ”€â†’â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”œâ”€ Enable voice? â”€â†’Yes            â”‚            â”‚          â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”œâ”€ POST request â”€â†’            â”‚          â”‚
â”‚              â”‚                â”‚ /api/voice/chat/            â”‚          â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”‚                â”œâ”€ Process â”€â”€â†’ Generate â”‚
â”‚              â”‚                â”‚                â”‚ TTS text    text      â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”‚                â”‚            â”œâ”€ Create â”‚
â”‚              â”‚                â”‚                â”‚            â”‚ audio   â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”‚                â”œâ”€ Encode base64      â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”‚â† Response â”€â”€â”€â”€â”‚            â”‚          â”‚
â”‚              â”‚â† Success dict â”€â”€â”‚ {text,audio}   â”‚            â”‚          â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”œâ”€ See text â”€â”€â”€â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”œâ”€ Decode audio â”€â”¤            â”‚          â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”œâ”€ Play audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
â”‚              â”‚                â”‚                â”‚            â”‚          â”œâ”€ Speaker
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”œâ”€ Hear speech â”€â”€â”¤                â”‚            â”‚          â”‚
â”‚              â”‚ (3-5 seconds)   â”‚                â”‚            â”‚          â”‚
â”‚              â”‚                â”‚                â”‚            â”‚          â”‚
â”‚              â”œâ”€ Can type next â”€â†’Ready           â”‚            â”‚          â”‚
â”‚
```

---

This architecture ensures:
- âœ… Seamless integration with existing AI Service
- âœ… Session continuity across messages
- âœ… Automatic audio playback
- âœ… Proper resource cleanup
- âœ… Error handling and recovery
- âœ… Scalable for future enhancements
