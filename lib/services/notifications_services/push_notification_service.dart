import 'dart:convert';import 'package:firebase_core/firebase_core.dart';import 'package:firebase_messaging/firebase_messaging.dart';import 'package:flutter_local_notifications/flutter_local_notifications.dart';import 'package:flutter/material.dart';import 'package:agri_guide/services/notifications_services/local_notification_service.dart';/// Background message handler must be a top-level functionFuture<void> _firebaseMessagingBackgroundHandler(RemoteMessage message) async {  // Ensure Firebase is initialized  await Firebase.initializeApp();  // Convert FCM payload to local notification  final data = message.data;  final title = data['title'] ?? message.notification?.title ?? 'Notification';  final body = data['body'] ?? message.notification?.body ?? '';  // Show via LocalNotificationService using a generated id  final int id = (data['id'] != null) ? int.tryParse(data['id'].toString()) ?? DateTime.now().millisecondsSinceEpoch.remainder(100000) : DateTime.now().millisecondsSinceEpoch.remainder(100000);  await LocalNotificationService.showNotification(    notificationId: id,    title: title,    body: body,    payload: jsonEncode(data),  );}class PushNotificationService {  static bool _initialized = false;  static Future<void> initialize() async {    if (_initialized) return;    // Initialize Firebase if not already    await Firebase.initializeApp();    // Set background handler    FirebaseMessaging.onBackgroundMessage(_firebaseMessagingBackgroundHandler);    final messaging = FirebaseMessaging.instance;    // Request permissions (iOS / Android 13+)    await messaging.requestPermission(alert: true, badge: true, sound: true);    // Get the token and print (or send to server)    final token = await messaging.getToken();    debugPrint('FCM token: $token');    // TODO: send token to your server for push targeting    // Handle foreground messages    FirebaseMessaging.onMessage.listen((RemoteMessage message) async {      debugPrint('FCM onMessage: ${message.data}');      final data = message.data;      final title = data['title'] ?? message.notification?.title ?? 'Notification';      final body = data['body'] ?? message.notification?.body ?? '';      final int id = (data['id'] != null) ? int.tryParse(data['id'].toString()) ?? DateTime.now().millisecondsSinceEpoch.remainder(100000) : DateTime.now().millisecondsSinceEpoch.remainder(100000);      await LocalNotificationService.showNotification(        notificationId: id,        title: title,        body: body,        payload: jsonEncode(data),      );    });    // Handle notification tap when app is in background    FirebaseMessaging.onMessageOpenedApp.listen((RemoteMessage message) {      debugPrint('FCM onMessageOpenedApp: ${message.data}');      // Try to parse payload and navigate      if (LocalNotificationService.navigatorKey?.currentContext != null) {        final ctx = LocalNotificationService.navigatorKey!.currentContext!;        // route to notifications page        Navigator.of(ctx).pushNamed('/notifications');      }    });    // Handle case when app was completely terminated and opened by a notification    final initialMessage = await FirebaseMessaging.instance.getInitialMessage();    if (initialMessage != null) {      debugPrint('FCM getInitialMessage: ${initialMessage.data}');      if (LocalNotificationService.navigatorKey?.currentContext != null) {        final ctx = LocalNotificationService.navigatorKey!.currentContext!;        Navigator.of(ctx).pushNamed('/notifications');      }    }    _initialized = true;  }}